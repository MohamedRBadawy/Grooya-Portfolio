# متطلبات الواجهة الخلفية لـ Grooya - Django API

تحدد هذه الوثيقة الخطة المعمارية للواجهة الخلفية (backend) لتطبيق Grooya، والتي سيتم بناؤها باستخدام Django و Django REST Framework (DRF). تتمثل الفلسفة الأساسية في **تقليل التعقيد** إلى أقصى حد ممكن من خلال الاستفادة من الميزات المدمجة في Django، مع توفير واجهة برمجية (API) قوية وقابلة للتطوير لدعم تجربة مستخدم عالمية المستوى.

---

## 1. استراتيجية التبسيط الأساسية: JSONField

لتجنب إنشاء شبكة معقدة من عشرات نماذج قاعدة البيانات (database models) لكل نوع من أقسام الملف الشخصي (`HeroBlock`, `AboutBlock`, إلخ) وكل خاصية تصميم، سنعتمد على حقل `JSONField` الذي يوفره Django.

-   **هيكل الملف الشخصي (Portfolio):** سيتم تخزين مصفوفة `pages` بأكملها، بما في ذلك جميع أقسام `blocks` بداخلها، في حقل `JSONField` واحد ضمن نموذج `Portfolio`.
-   **نظام التصميم (Design System):** سيتم تخزين كائن `design` بأكمله في حقل `JSONField` آخر.

### لماذا هذا أبسط وأفضل:
-   **تقليل كبير في عدد النماذج (Models):** ننتقل من أكثر من 20 نموذجًا محتملاً إلى عدد قليل من النماذج الأساسية.
-   **المرونة:** يمكن للواجهة الأمامية (frontend) تطوير هيكل الأقسام وإضافة أنواع جديدة دون الحاجة إلى أي عمليات ترحيل (migrations) لقاعدة البيانات في الواجهة الخلفية.
-   **الأداء:** جلب بيانات ملف شخصي كامل يتطلب قراءة واحدة من قاعدة البيانات، بدلاً من سلسلة من عمليات الربط (joins) المعقدة.
-   **التكافؤ بين الواجهة الأمامية والخلفية:** هيكل البيانات في قاعدة البيانات يطابق تمامًا أنواع TypeScript في الواجهة الأمامية، مما يجعل عمليات التحويل (serialization/deserialization) سهلة للغاية.

---

## 2. تعريف نماذج جانغو (Django Models)

سنقوم بتعريف عدد قليل من النماذج الأساسية.

-   **`User` (يرث من `django.contrib.auth.models.AbstractUser`)**
    -   سنستخدم نموذج المستخدم المدمج في Django ونقوم بتوسيعه.
    -   `title`: `CharField` (مثال: "Senior Frontend Engineer")
    -   `bio`: `TextField`
    -   `avatar_url`: `URLField`
    -   `subscription_tier`: `CharField` (الخيارات: 'free', 'pro')
    -   `ai_text_credits`: `IntegerField`
    -   `ai_image_credits`: `IntegerField`

-   **`Portfolio` (الملف الشخصي)**
    -   `user`: `ForeignKey` يشير إلى `User` (المالك)
    -   `title`: `CharField`
    -   `slug`: `SlugField` (فريد)
    -   `design`: `JSONField` (يخزن كائن التصميم بالكامل)
    -   `pages`: `JSONField` (يخزن مصفوفة الصفحات وأقسامها بالكامل)
    -   `is_published`: `BooleanField`
    -   `is_guided`: `BooleanField` (لتتبع وضع المرشد الذكي)
    -   `goal`: `CharField` (الخيارات: 'job', 'freelance', 'personal')
    -   `role`: `CharField`
    -   `created_at`, `updated_at`: `DateTimeField` (تتم إدارتها تلقائيًا)

-   **`Project` (المشروع)**
    -   `user`: `ForeignKey` يشير إلى `User` (المالك)
    -   `title`: `CharField`
    -   `description`: `TextField`
    -   `image_url`: `URLField`
    -   `technologies`: `JSONField` (يخزن مصفوفة من النصوص)
    -   `link`: `URLField`

-   **`Skill` (المهارة)**
    -   `user`: `ForeignKey` يشير إلى `User` (المالك)
    -   `name`: `CharField`
    -   `category`: `CharField` (الخيارات: 'Language', 'Framework', 'Tool', إلخ)

-   **`Resume` (السيرة الذاتية)**
    -   `user`: `ForeignKey` يشير إلى `User` (المالك)
    -   `title`: `CharField`
    -   `content`: `JSONField` (يخزن جميع أقسام السيرة الذاتية مثل الملخص، الخبرة، إلخ)
    -   `created_at`, `updated_at`: `DateTimeField` (تتم إدارتها تلقائيًا)

-   **`PortfolioAsset` (أصول الملف الشخصي)**
    -   `user`: `ForeignKey` يشير إلى `User` (المالك)
    -   `file`: `ImageField` (يتعامل مع رفع ملف الصورة الفعلي)
    -   `prompt`: `TextField` (للصور التي تم إنشاؤها بواسطة الذكاء الاصطناعي)
    -   `created_at`: `DateTimeField` (تتم إدارتها تلقائيًا)

---

## 3. هيكل نقاط النهاية (API Endpoints) - (Django REST Framework)

سنستخدم `ModelViewSet` من DRF لإنشاء معظم نقاط نهاية CRUD (إنشاء، قراءة، تحديث، حذف) تلقائيًا.

-   **المصادقة (`/api/auth/`)**
    -   استخدام JWT (JSON Web Tokens) لمصادقة حديثة وعديمة الحالة (stateless).
    -   `/api/auth/register/`: إنشاء مستخدم جديد.
    -   `/api/auth/login/`: الحصول على توكن JWT للوصول والتحديث.
    -   `/api/auth/user/`: الحصول على بيانات المستخدم الذي قام بتسجيل الدخول.

-   **الملفات الشخصية (`/api/portfolios/`)**
    -   `GET /`: عرض جميع الملفات الشخصية للمستخدم المصادق عليه.
    -   `POST /`: إنشاء ملف شخصي جديد.
    -   `GET /<id>/`: استرداد ملف شخصي معين.
    -   `PUT/PATCH /<id>/`: تحديث ملف شخصي.
    -   `DELETE /<id>/`: حذف ملف شخصي.
    -   **العرض العام:** `GET /api/public/portfolios/<slug>/` - نقطة نهاية منفصلة و**غير مصادق عليها** لجلب بيانات ملف شخصي منشور.

-   **المشاريع (`/api/projects/`)**
    -   نقاط نهاية CRUD كاملة لمكتبة مشاريع المستخدم.

-   **المهارات (`/api/skills/`)**
    -   نقاط نهاية CRUD كاملة لمهارات المستخدم.

-   **السير الذاتية (`/api/resumes/`)**
    -   نقاط نهاية CRUD كاملة للسير الذاتية للمستخدم.

-   **الأصول (`/api/assets/`)**
    -   `GET /`: عرض جميع أصول الصور للمستخدم.
    -   `POST /`: رفع أصل صورة جديد.
    -   `DELETE /<id>/`: حذف أصل.

-   **خدمات الذكاء الاصطناعي (`/api/ai/`)**
    -   **هذا تحسين حاسم لتجربة المستخدم والأمان.** لن تقوم الواجهة الأمامية باستدعاء Gemini API مباشرة بعد الآن. بدلاً من ذلك، ستستدعي الواجهة الخلفية الخاصة بنا، والتي تقوم بدورها باستدعاء Gemini API بشكل آمن باستخدام مفتاح مخفي.
    -   `POST /api/ai/generate-text/`: نقطة نهاية عامة لجميع عمليات إنشاء النصوص المستندة إلى الذكاء الاصطناعي (محتوى قسم الواجهة، أوصاف المشاريع، تخصيص السيرة الذاتية). سيحدد جسم الطلب `task` (المهمة) و `payload` (البيانات) الخاصة بها.
    -   `POST /api/ai/generate-image/`: نقطة نهاية تأخذ وصفًا (prompt)، وتستدعي نموذج إنشاء الصور، وتتعامل مع تخزين الصورة الناتجة (على سبيل المثال، إلى S3) وإنشاء سجل `PortfolioAsset`.

---

## 4. تفاصيل التنفيذ الرئيسية

-   **المصادقة:** استخدام `dj-rest-auth` و `djangorestframework-simplejwt` لإعداد JWT سريع وآمن.
-   **الأذونات (Permissions):** إنشاء صنف إذن مخصص `IsOwner` في DRF لضمان أن يتمكن المستخدمون فقط من الوصول إلى بياناتهم وتعديلها. ستستخدم نقطة نهاية الملف الشخصي العام إذن `AllowAny`.
-   **تخزين الصور/الأصول (تحسين تجربة المستخدم):** بدلاً من تخزين الصور على نظام ملفات الخادم، سنستخدم حل تخزين سحابي مثل AWS S3 أو Cloudinary، تتم إدارته عبر مكتبة `django-storages`. هذا الحل أكثر قابلية للتطوير وأفضل أداءً (مما يتيح استخدام CDN للتسليم).
-   **لوحة تحكم جانغو (تبسيط هائل):** بمجرد تسجيل نماذجنا في Django Admin، نحصل على "لوحة تحكم إدارية" كاملة وآمنة مجانًا. هذا يغطي بالكامل قسم "Phase 4: Administration & Platform Management" من خطة الواجهة الأمامية دون أي عمل إضافي تقريبًا. يمكن للمسؤولين إدارة المستخدمين، وعرض جميع الملفات الشخصية، وإلغاء نشر المحتوى، وما إلى ذلك، مباشرة من هذه الواجهة.
